{% extends "manager/frame.html" %}{% block manager %}
<h2 class="text-2xl font-extrabold mb-4">Overview</h2>
<div class="grid md:grid-cols-3 gap-4">
  <div class="bg-white rounded-xl p-4 border shadow-glass"><div class="text-base-muted">Assigned</div><div id="count-assigned" class="text-3xl font-extrabold">{{ stats.assigned or 0 }}</div></div>
  <div class="bg-white rounded-xl p-4 border shadow-glass"><div class="text-base-muted">New</div><div id="count-new" class="text-3xl font-extrabold">{{ stats.new or 0 }}</div></div>
  <div class="bg-white rounded-xl p-4 border shadow-glass"><div class="text-base-muted">Closed</div><div id="count-closed" class="text-3xl font-extrabold">{{ stats.closed or 0 }}</div></div>
</div>
<div class="grid lg:grid-cols-2 gap-4 mt-6">
  <div class="bg-white rounded-xl p-4 border shadow-glass"><canvas id="m"></canvas></div>
  <div class="bg-white rounded-xl p-4 border shadow-glass"><canvas id="c"></canvas></div>
</div>
<script>
const colors=["#3b82f6","#22c55e","#ec4899","#8b5cf6","#f59e0b","#06b6d4","#64748b","#ef4444"];
const chartM=new Chart(document.getElementById('m'),{
  type:'line',data:{labels:{{ monthly|map(attribute='ym')|list|tojson }},
  datasets:[{label:'Reports',data:{{ monthly|map(attribute='cnt')|list|tojson }},borderColor:colors[1]}]}
});
const chartC=new Chart(document.getElementById('c'),{
  type:'bar',data:{labels:{{ bycat|map(attribute='category')|list|tojson }},
  datasets:[{label:'By Category',data:{{ bycat|map(attribute='cnt')|list|tojson }},backgroundColor:colors}]}
});

async function refresh(){
  const res=await fetch("{{ url_for('manager_stats_api') }}");
  const data=await res.json();
  document.getElementById('count-assigned').textContent=data.stats.assigned;
  document.getElementById('count-new').textContent=data.stats.new;
  document.getElementById('count-closed').textContent=data.stats.closed;

  chartM.data.labels=data.monthly.map(r=>r.ym);
  chartM.data.datasets[0].data=data.monthly.map(r=>r.cnt);
  chartC.data.labels=data.bycat.map(r=>r.category);
  chartC.data.datasets[0].data=data.bycat.map(r=>r.cnt);
  chartM.update();
  chartC.update();
}
setInterval(refresh,10000);
refresh();
</script>
{% endblock %}
