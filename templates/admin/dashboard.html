{% extends "admin/frame.html" %}{% block admin %}
<h2 class="text-2xl font-extrabold mb-4">Overview</h2>
<div class="grid md:grid-cols-4 gap-4">
  <div class="bg-white rounded-xl p-4 border shadow-glass"><div class="text-base-muted">New</div><div id="count-new" class="text-3xl font-extrabold">{{ stats.new or 0 }}</div></div>
  <div class="bg-white rounded-xl p-4 border shadow-glass"><div class="text-base-muted">In Process</div><div id="count-inproc" class="text-3xl font-extrabold">{{ stats.inproc or 0 }}</div></div>
  <div class="bg-white rounded-xl p-4 border shadow-glass"><div class="text-base-muted">Closed</div><div id="count-closed" class="text-3xl font-extrabold">{{ stats.closed or 0 }}</div></div>
  <div class="bg-white rounded-xl p-4 border shadow-glass"><div class="text-base-muted">Avg. First Response</div><div id="avg-hours" class="text-3xl font-extrabold">{{ avg_hours }} h</div></div>
</div>

<div class="grid lg:grid-cols-3 gap-4 mt-6">
  <div class="bg-white rounded-xl p-4 border shadow-glass"><canvas id="byMonth"></canvas></div>
  <div class="bg-white rounded-xl p-4 border shadow-glass"><canvas id="byCat"></canvas></div>
  <div class="bg-white rounded-xl p-4 border shadow-glass"><canvas id="byStatus"></canvas></div>
</div>

<div class="bg-white rounded-xl p-4 border shadow-glass mt-6">
  <h3 class="font-bold mb-2">Companies</h3>
  <table class="w-full text-sm">
    <tr class="text-left border-b"><th class="py-2">Name</th><th>Code</th><th>New</th><th>In Process</th><th>Closed</th><th></th></tr>
    {% for c in companies %}
      <tr class="border-b">
        <td class="py-2">{{ c.name }}</td>
        <td><code>{{ c.code }}</code></td>
        <td>{{ c.newc or 0 }}</td>
        <td>{{ c.inpc or 0 }}</td>
        <td>{{ c.clos or 0 }}</td>
        <td><a class="text-neon-blue" href="{{ url_for('admin_company', company_id=c.id) }}">View</a></td>
      </tr>
    {% endfor %}
  </table>
</div>

<script>
const colors = ["#3b82f6","#22c55e","#ec4899","#8b5cf6","#f59e0b","#06b6d4","#64748b","#ef4444"];
const chartMonth = new Chart(document.getElementById('byMonth'), {
  type:'line',
  data:{labels:{{ monthly|map(attribute='ym')|list|tojson }},
        datasets:[{label:'Reports',data:{{ monthly|map(attribute='cnt')|list|tojson }},
                   borderColor:colors[0]}]}
});
const chartCat = new Chart(document.getElementById('byCat'), {
  type:'bar',
  data:{labels:{{ bycat|map(attribute='category')|list|tojson }},
        datasets:[{label:'By Category',data:{{ bycat|map(attribute='cnt')|list|tojson }},
                   backgroundColor:colors}]}
});
const chartStatus = new Chart(document.getElementById('byStatus'), {
  type:'doughnut',
  data:{labels:{{ bystatus|map(attribute='status')|list|tojson }},
        datasets:[{data:{{ bystatus|map(attribute='cnt')|list|tojson }},backgroundColor:colors}]}
});

async function refresh() {
  const res = await fetch("{{ url_for('admin_stats_api') }}");
  const data = await res.json();
  document.getElementById('count-new').textContent = data.stats.new;
  document.getElementById('count-inproc').textContent = data.stats.inproc;
  document.getElementById('count-closed').textContent = data.stats.closed;
  document.getElementById('avg-hours').textContent = data.stats.avg_hours + ' h';

  chartMonth.data.labels = data.monthly.map(r => r.ym);
  chartMonth.data.datasets[0].data = data.monthly.map(r => r.cnt);
  chartCat.data.labels = data.bycat.map(r => r.category);
  chartCat.data.datasets[0].data = data.bycat.map(r => r.cnt);
  chartStatus.data.labels = data.bystatus.map(r => r.status);
  chartStatus.data.datasets[0].data = data.bystatus.map(r => r.cnt);
  chartMonth.update();
  chartCat.update();
  chartStatus.update();
}
setInterval(refresh, 10000);
refresh();
</script>
{% endblock %}
