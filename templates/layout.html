<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ title or "CareWhistle" }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme:{
        extend:{
          colors:{
            base: { bg:"#f7f8fb", card:"#ffffff", ink:"#111827", muted:"#6b7280" },
            neon: { blue:"#3b82f6", green:"#22c55e", pink:"#ec4899", purple:"#8b5cf6", amber:"#f59e0b", cyan:"#06b6d4" }
          },
          boxShadow:{
            glass:"0 10px 30px rgba(31,41,55,.08), inset 0 1px 0 rgba(255,255,255,.5)"
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ctext y='50'%3E%F0%9F%9A%A8%3C/text%3E%3C/svg%3E">
</head>
<body class="bg-base-bg text-base-ink">
  <header class="sticky top-0 z-40 backdrop-blur bg-white/80 border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
      <a href="{{ url_for('home') }}" class="flex items-center gap-2 font-extrabold text-lg">
        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-neon-blue text-white shadow-glass">🔔</span>
        <span>CareWhistle</span>
      </a>
      <nav class="ml-6 flex items-center gap-4 text-sm">
        <a class="hover:text-neon-blue" href="{{ url_for('home') }}">Home</a>
        <a class="hover:text-neon-blue" href="{{ url_for('how') }}">How it works</a>
        <a class="hover:text-neon-blue" href="{{ url_for('report') }}">Make a Report</a>
        <a class="hover:text-neon-blue" href="{{ url_for('pricing') }}">Plans & Pricing</a>
      </nav>
      <div class="ml-auto flex items-center gap-2">
        <a class="px-3 py-1.5 rounded-lg bg-neutral-100 hover:bg-neutral-200" href="{{ url_for('follow') }}">Case Portal</a>
        {% if session.get('user_id') %}
          {% if session.get('role')=='admin' %}
            <a class="px-3 py-1.5 rounded-lg bg-neon-blue text-white" href="{{ url_for('admin_dashboard') }}">Admin</a>
          {% elif session.get('role')=='manager' %}
            <a class="px-3 py-1.5 rounded-lg bg-neon-purple text-white" href="{{ url_for('manager_overview') }}">Manager</a>
          {% endif %}
          <a class="px-3 py-1.5 rounded-lg bg-neutral-800 text-white" href="{{ url_for('logout') }}">Logout</a>
        {% else %}
          <a class="px-3 py-1.5 rounded-lg bg-neutral-800 text-white" href="{{ url_for('login') }}">Login</a>
        {% endif %}
      </div>
    </div>
  </header>

  {% with msgs = get_flashed_messages(with_categories=True) %}
    {% if msgs %}
    <div class="max-w-4xl mx-auto mt-4 px-4">
      {% for c,m in msgs %}
        <div class="mb-2 px-4 py-2 rounded-lg border bg-white shadow">{{ m }}</div>
      {% endfor %}
    </div>
    {% endif %}
  {% endwith %}

  {% block body %}{% endblock %}

  <footer class="mt-16 py-8 text-center text-sm text-base-muted">
    © {{ 2025 }} CareWhistle — Independent whistleblowing service. <span class="mx-2">•</span> help@carewhistle.app
  </footer>
  <div id="cw-chatbot" class="fixed bottom-4 right-4 text-sm">
    <button id="cw-chatbot-toggle" class="bg-neon-blue text-white rounded-full w-12 h-12 shadow-lg flex items-center justify-center">💬</button>
    <div id="cw-chatbot-box" class="hidden w-80 sm:w-96 bg-white rounded-lg shadow-lg border flex flex-col">
      <div class="p-3 border-b font-bold flex justify-between">
        <span>CareWhistle Chat</span>
        <button id="cw-chatbot-close" class="text-xl leading-none">&times;</button>
      </div>
      <div id="cw-chatbot-messages" class="p-3 flex-1 overflow-y-auto space-y-2"></div>
      <div id="cw-chatbot-options" class="p-3 border-t"></div>
    </div>
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('cw-chatbot-toggle');
    const box = document.getElementById('cw-chatbot-box');
    const closeBtn = document.getElementById('cw-chatbot-close');
    const msgs = document.getElementById('cw-chatbot-messages');
    const opts = document.getElementById('cw-chatbot-options');

    function addMsg(sender, html) {
      const wrapper = document.createElement('div');
      wrapper.className = sender === 'bot' ? 'text-left' : 'text-right';
      wrapper.innerHTML = `<div class="${sender === 'bot' ? 'bg-neutral-100' : 'bg-neon-blue text-white'} inline-block px-3 py-2 rounded-lg">${html}</div>`;
      msgs.appendChild(wrapper);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function start() {
      msgs.innerHTML = '';
      opts.innerHTML = '';
      addMsg('bot', 'What would you like help with?');
      const buttons = [
        {id:'contact', text:'Contact info@carewhistle.com'},
        {id:'problem', text:'Report a problem or issue'},
        {id:'report', text:'Submit a whistleblowing report'},
        {id:'learn', text:'Learn more about CareWhistle'}
      ];
      buttons.forEach(b => {
        const btn = document.createElement('button');
        btn.textContent = b.text;
        btn.className = 'block w-full text-left px-3 py-2 mt-2 rounded bg-neutral-100 hover:bg-neutral-200';
        btn.onclick = () => handleChoice(b.id);
        opts.appendChild(btn);
      });
    }

    async function handleChoice(id) {
      opts.innerHTML = '';
      if (id === 'contact') {
        addMsg('user', 'Contact info@carewhistle.com');
        addMsg('bot', 'You can reach us at <a class="text-neon-blue underline" href="mailto:info@carewhistle.com">info@carewhistle.com</a>.');
      } else if (id === 'report') {
        addMsg('user', 'Submit a whistleblowing report');
        addMsg('bot', 'Please use our <a class="text-neon-blue underline" href="/report">report page</a>.');
      } else if (id === 'learn') {
        addMsg('user', 'Learn more about CareWhistle');
        addMsg('bot', 'CareWhistle is an independent whistleblowing service that enables secure and anonymous reporting for care organisations.');
      } else if (id === 'problem') {
        addMsg('user', 'Report a problem or issue');
        addMsg('bot', 'Please describe the problem below:');
        const form = document.createElement('form');
        form.className = 'space-y-2 mt-2';
        form.innerHTML = `\
<input name="contact" type="text" placeholder="Your email (optional)" class="w-full border rounded px-2 py-1">\
<textarea name="message" required placeholder="Describe the problem" class="w-full border rounded px-2 py-1"></textarea>\
<button type="submit" class="bg-neon-blue text-white px-3 py-1 rounded">Submit</button>`;
        opts.appendChild(form);
        form.onsubmit = async (e) => {
          e.preventDefault();
          const fd = new FormData(form);
          addMsg('user', fd.get('message'));
          const res = await fetch('/problem', {method:'POST', body: fd});
          if (res.ok) {
            addMsg('bot', 'Thanks for letting us know. We will look into it.');
          } else {
            addMsg('bot', 'Sorry, there was an error submitting your problem.');
          }
          opts.innerHTML = '';
          const restart = document.createElement('button');
          restart.textContent = 'Start over';
          restart.className = 'mt-4 px-3 py-1 rounded bg-neutral-100 hover:bg-neutral-200';
          restart.onclick = start;
          opts.appendChild(restart);
        };
        return;
      }
      const restart = document.createElement('button');
      restart.textContent = 'Start over';
      restart.className = 'mt-4 px-3 py-1 rounded bg-neutral-100 hover:bg-neutral-200';
      restart.onclick = start;
      opts.appendChild(restart);
    }

    toggle.onclick = () => {
      box.classList.toggle('hidden');
      if (!box.classList.contains('hidden')) start();
    };
    closeBtn.onclick = () => box.classList.add('hidden');
  });
  </script>
</body>
</html>
